name: Pull Request CI

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - README.md
      - CHANGELOG.md
      - LICENSE
      - CONTRIBUTING.md
      - docs/**
      - mkdocs.yml

defaults:
  run:
    shell: bash -l {0}

jobs:
  test:
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        py3version: ["9", "10", "11"]
      fail-fast: false
    uses: arup-group/actions-city-modelling-lab/.github/workflows/python-install-lint-test.yml@main
    with:
      os: ubuntu-latest
      py3version: "11"
      lint: false
      upload_to_codecov: false

  build-template:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: latest
          environment-name: ${{ github.event.repository.name }}-cookiecutter
          create-args: >-
            cookiecutter
            python=3.11
          post-cleanup: all
          cache-environment: true

      - name: install package
        run: cookiecutter --no-input .

      - name: upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: built-package
          path: python_boilerplate/
          if-no-files-found: error
          retention-days: 5

  test-template:
    runs-on: ubuntu-latest
    needs: build-template
    steps:
      - name: Download built package
        uses: actions/download-artifact@v3
        with:
          name: built-package
          path: "."

      - uses: mamba-org/setup-micromamba@v1
        with:
          micromamba-version: latest
          environment-name: built-template-env
          environment-file: requirements/base.txt
          create-args: >-
            -f requirements/dev.txt
            ruff=0.0.286
            python=3.11
          post-cleanup: all
          cache-environment: false

      - name: Install package
        run: pip install --no-dependencies -e .

      - name: Install jupyter kernel
        run: python -m ipykernel install --user --name python_boilerplate

      - name: Lint with Ruff
        run: ruff check .

      - name: run tests
        run: pytest

      - name: Test that docs build
        run: mkdocs build